<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <record model="ir.ui.view" id="phieu_kham_tree_view_extend">
            <field name="name">phieu_kham_tree_view_extend</field>
            <field name="model">sh.medical.appointment.register.walkin</field>
            <field name="type">tree</field>
            <field name="priority">10</field>
            <field name="arch" type="xml">
                <tree create="0" limit="10" duplicate="false" delete="false" string="Walkin Details"
                      decoration-info="state=='Scheduled'" decoration-bf="state=='WaitPayment'"
                      decoration-it="state=='Payment'" decoration-success="state=='Completed'"
                      decoration-danger="state=='InProgress'" default_order="date desc">
                    <field name="patient_level" widget="label_selection"
                           options="{'classes': {'1': 'success', '2': 'info', '3': 'warning', '4': 'danger'}}"/>
                    <field name="date" widget="date"/>
                    <field name="index_by_day" optional="hide"/>
                    <field name="booking_id" optional="show"/>
                    <field name="name" optional="show"/>
                    <field name="patient" class="text-uppercase" optional="show"/>
                    <field name="dob" optional="hide"/>
                    <field name="sex" optional="show"/>
                    <field name="institution" optional="hide"/>
                    <field name="service_room" optional="show"/>
                    <field name="reason_check" optional="hide"/>
                    <field name="doctor" optional="hide"/>
                    <field name="state" optional="hide"/>
                    <field name="note" optional="hide"/>
                    <field name="sale_order_id" optional="hide"/>
                </tree>
            </field>
        </record>

        <record model="ir.ui.view" id="phieu_kham_form_view_extend">
            <field name="name">Walkins</field>
            <field name="model">sh.medical.appointment.register.walkin</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Walkins" create="0" duplicate="false"
                      edit_expr="state not in ['WaitPayment','Payment','Completed','Cancelled']">
                    <header>
                        <button name="print_report_hospital_discharge_sheet" states="Completed"
                                string="Phiếu ra viện" type="object" class="btn-success fa fa-print"
                                title="In phiếu ra viện cho bệnh nhân"/>
                        <button name="add_evaluations"
                                type="object" states="Completed" class="btn-success fa fa-plus"
                                context="{'default_institution': institution,'default_walkin': active_id,'default_patient':patient,'default_services':service,'default_admission_reason_walkin': reason_check}"
                                string="Phiếu tái khám" title="Tạo phiếu tái khám từ phiếu khám này"/>
                        <button confirm="Bạn có chắc muốn tạo một yêu cầu thu phí cho phiếu này?"
                                name="create_draft_payment" string="Yêu cầu thu phí"
                                attrs="{'invisible': ['|',('is_missing_money','=', False),('state','in',['Completed','Cancelled'])]}"
                                type="object" class="btn-success fa fa-money"
                                groups="shealth_all_in_one.group_sh_medical_physician"
                                title="Tạo một yêu cầu thu phí cho phiếu khám"/>
                        <button confirm="Bạn có chắc muốn đặt lại phiếu này về Khám?" name="return_draft_status"
                                states="WaitPayment" string="Đặt là Khám" type="object"
                                class="btn-warning fa fa-step-forward"
                                title="Chuyển phiếu khám sang trạng thái 'Khám'"/>
                        <button confirm="Bạn có chắc muốn đặt lại phiếu này về Khám?" name="return_draft_status_admin"
                                states="Cancelled" string="Đặt là Khám (Admin)" type="object"
                                class="btn-warning fa fa-step-forward"
                                groups="base.group_system" title="Chuyển phiếu khám sang trạng thái 'Khám'"/>
                        <button confirm="Bạn có chắc muốn đánh dấu phiếu này Đang thực hiện?" name="set_to_progress"
                                states="Payment" string="Đang thực hiện" type="object"
                                class="btn-warning fa fa-step-forward"
                                groups="shealth_all_in_one.group_sh_medical_physician"
                                title="Chuyển phiếu khám sang trạng thái 'Đang thực hiện'"/>
                        <button confirm="Bạn có chắc muốn đánh dấu phiếu này Đang thực hiện (Chỉ Admin)?"
                                name="set_to_progress_admin" states="Completed" string="Đang thực hiện"
                                title="Chuyển phiếu khám sang trạng thái 'Đang thực hiện'"
                                type="object" class="btn-warning fa fa-step-forward"
                                groups="shealth_all_in_one.group_sh_medical_manager"/>
                        <button confirm="Bạn có chắc muốn đánh dấu phiếu này Đã Hoàn thành?" name="set_to_completed"
                                states="InProgress" string="Đã Hoàn thành" type="object" class="btn-warning fa fa-check"
                                groups="shealth_all_in_one.group_sh_medical_physician"
                                title="Chuyển phiếu khám sang trạng thái 'Hoàn thành'"/>
                        <button confirm="Bạn có chắc muốn hủy phiếu này?" name="set_to_cancelled"
                                states="Scheduled,InProgress,WaitPayment,Payment" string="Đặt là hủy" type="object"
                                class="btn-warning fa fa-check" title="Chuyển phiếu khám sang trạng thái 'Hủy'"
                                groups="shealth_all_in_one.group_sh_medical_stock_user,shealth_all_in_one.group_sh_medical_receptionist,shealth_all_in_one.group_sh_medical_manager"/>
                        <button name="view_walkin_material" states="InProgress,Completed" string="VTTH của Phiếu"
                                type="object" class="btn-info fa fa-list" title="Xem vật tư tiêu hao của phiếu khám"
                                groups="shealth_all_in_one.group_sh_medical_physician,shealth_all_in_one.group_sh_medical_accountant"/>
                        <field name="state" widget="statusbar"
                               statusbar_visible="Scheduled,WaitPayment,InProgress,Completed,Cancelled"
                               statusbar_colors='{"Scheduled":"blue","InProgress":"red","Completed":"green","Cancelled":"grey"}'/>
                    </header>
                    <sheet>
                        <div class="row">
                            <div class="oe_title col-2">
                                <label for="name" string="Mã phiếu khám:"/>
                                <h2>
                                    <field name="name" class="oe_inline" force_save="1" readonly="1"
                                           widget="copy_char"/>
                                </h2>
                            </div>
                            <div class="oe_title col-2">
                                <label for="partner_id" string="Tên khách hàng:"/>
                                <h2>
                                    <field name="partner_id" force_save="1" readonly="1"/>
                                </h2>
                            </div>
                            <div class="oe_title col-2">
                                <label for="dob" string="Ngày sinh:"/>
                                <h2>
                                    <field name="dob" force_save="1" readonly="1"/>
                                </h2>
                            </div>
                            <div class="oe_title col-3">
                                <label for="address" string="Địa chỉ:"/>
                                <h2>
                                    <field name="address" style="white-space: unset;overflow:unset"/>
                                </h2>
                            </div>
                            <div class="oe_title col-3">
                                <div style="display: flex;flex-direction: row;">
                                    <div class="oe_title text-center border p-2">
                                        <label for="specialty_count" string="Specialty"/>
                                        <h2>
                                            <span title="Total">
                                                <field name="specialty_count" class="text-primary"
                                                       style="overflow: unset;"/>
                                            </span>
                                        </h2>
                                    </div>
                                    <div class="oe_title text-center border p-2">
                                        <label for="surgery_count" string="Surgery"/>
                                        <h2>
                                            <span title="Total">
                                                <field name="surgery_count" class="text-primary"
                                                       style="overflow: unset;"/>
                                            </span>
                                        </h2>
                                    </div>
                                    <div class="oe_title text-center border p-2">
                                        <label for="img_test_count" string="Imaging test"/>
                                        <h2>
                                            <span title="Done">
                                                <field name="img_test_done_count" class="text-success"
                                                       style="overflow: unset;"/>
                                            </span>
                                            /
                                            <span title="Total">
                                                <field name="img_test_count" class="text-primary"
                                                       style="overflow: unset;"/>
                                            </span>
                                        </h2>
                                    </div>
                                    <div class="oe_title text-center border p-2">
                                        <label for="lab_type_count" string="Lab test"/>
                                        <h2>
                                            <span title="Done">
                                                <field name="lab_test_done_count" class="text-success"
                                                       style="overflow: unset;"/>
                                            </span>
                                            /
                                            <span title="Total">
                                                <field name="lab_test_count" class="text-primary"
                                                       style="overflow: unset;"/>
                                            </span>
                                        </h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <notebook>
                            <page name="infomation" string="Thông tin chung" icon="fa fa-info">
                                <group>
                                    <group class="col-4" name="info">
                                        <field name="booking_id" options="{'no_create': True}" readonly="1"
                                               force_save="1" icon="fa fa-file-text-o"/>
                                        <field name="sale_order_id" invisible="1"/>
                                        <field name="patient" invisible="1"/>
                                        <field name="sex" invisible="1"/>
                                        <field name="type_crm_id" force_save="1" readonly="1"
                                               options="{'no_open': True}" invisible="1"/>
                                        <field name="root_walkin" options="{'no_create': True}"
                                               domain="[('patient','=',patient)]" icon="fa fa-file-text-o"
                                               attrs="{'required': [('type_crm_id','=',%(crm_base.type_oppor_guarantee)d)],'invisible': [('type_crm_id','!=',%(crm_base.type_oppor_guarantee)d)]}"/>
                                        <field name="allow_institutions" invisible="1"/>
                                        <field name="is_missing_money" invisible="1"/>
                                        <field name="institution" domain="[('id', 'in', allow_institutions)]"
                                               options="{'no_create': True,'no_open': True}" readonly="1"
                                               icon="fa fa-building"
                                               force_save="1"/>
                                        <field name="department" options="{'no_create': True}" invisible="1"/>
                                        <field name="related_department" options="{'no_create': True}" invisible="1"/>
                                        <field name="service_room" icon="fa fa-building-o"
                                               attrs="{'readonly': [('state','not in',['Scheduled'])]}"
                                               string="Phòng khám" options="{'no_create': True,'no_open': True}"
                                               required="True"
                                               force_save="1"/>
                                        <field name="room_type" invisible="1"/>
                                        <field name="reason_check" required="True" force_save="1"
                                               icon="fa fa-sticky-note-o"
                                               string="Lý do vào viện"/>
                                        <field name="pathological_process" icon="fa fa-sticky-note-o"
                                               attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                               force_save="1"/>
                                        <field name="info_diagnosis" string="Chuẩn đoán vào viện"
                                               icon="fa fa-sticky-note-o"/>
                                    </group>
                                    <group class="col-3" name="examination">
                                        <field name="date" icon="fa fa-calendar"
                                               attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                               force_save="1"/>
                                        <field name="service_date" attrs="{'readonly': [('state','=','Completed')]}"
                                               icon="fa fa-calendar"
                                               required="1"/>
                                        <field name="service_date_start" readonly="True" icon="fa fa-calendar"/>
                                        <field name="doctor" required="0" icon="fa fa-user"
                                               domain="[('is_pharmacist', '=', False),('speciality', 'not in', [%(shealth_all_in_one.33)d,%(shealth_all_in_one.5)d]),('department','in', related_department)]"
                                               options="{'no_create': True,'no_open': True}"
                                               attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                               force_save="1"/>
                                        <field name="flag_surgery" invisible="1"/>
                                        <field name="doctor_order" options="{'no_create': True,'no_open': True}"
                                               icon="fa fa-user"
                                               attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])], 'invisible': [('flag_surgery','=',False)]}"
                                               force_save="1"/>
                                        <field name="reception_nurse" required="0" icon="fa fa-user"
                                               domain="[('is_pharmacist', '=', False),('speciality', 'in', [%(shealth_all_in_one.33)d,%(shealth_all_in_one.11)d,%(shealth_all_in_one.51)d,%(shealth_all_in_one.60)d]),('department','in', related_department)]"
                                               options="{'no_create': True,'no_open': True}"
                                               attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                               force_save="1"/>
                                        <field name="note" icon="fa fa-sticky-note-o"/>
                                    </group>
                                    <group class="col-5" string="Hướng xử trí">
                                        <field name="pricelist_products" invisible="1"/>
                                        <field name="service" widget="many2many_tags" options="{'no_create': True}"
                                               domain="[('exam_room','=',service_room), ('product_id', 'in', pricelist_products)]"
                                               attrs="{'readonly': [('state','in',['Completed'])]}" icon="fa fa-list-ul"
                                               context="{'tree_view_ref': 'shealth_all_in_one.sh_medical_service_tree_simple'}"
                                               force_save="1"/>
                                        <field name="uom_price" readonly="1" force_save="1" invisible="1"/>
                                        <field name="teeths" readonly="1" force_save="1" icon="fa fa-list-ul"
                                               attrs="{'invisible': [('room_type','not in',['Odontology'])]}"
                                               widget="many2many_tags" options="{'no_create': True}"/>
                                        <field name="pathology" options="{'no_create': True,'no_open': True}"
                                               icon="fa fa-list-ul"
                                               attrs="{'readonly': [('state','in',['Completed'])]}" force_save="1"/>
                                    </group>
                                </group>
                                <group>
                                    <div class="col-12 o_group_col_12 text-info show_normal_exam"
                                         style="cursor: pointer;"
                                         title="Click vào để xem thông tin khám bệnh tổng quan"
                                         onclick="(function(){$('.show_normal_exam i').toggle();$('.normal_exam').slideToggle();})()">
                                        <i class="fa fa-minus p-2" style="display:none;"></i>
                                        <i class="fa fa-plus p-2"></i>
                                        <b>XEM THÔNG TIN KHÁM TỔNG QUAN</b>
                                    </div>
                                    <group class="normal_exam col-12 o_group_col_12" style="display:none;">
                                        <group class="col-5" string="Khám bệnh">
                                            <field name="physical_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="cyclic_info"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="respiratory_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="digest_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="reins_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="nerve_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="other_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="specialty_exam"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                        </group>
                                        <group class="col-4" string="Tiền sử bệnh">
                                            <field name="surgery_history"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="medical_history"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="allergy_history"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="family_history"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                        </group>
                                        <group class="col-3" string="Các chỉ số">
                                            <field name="temperature"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <label for="systolic" string="Huyết áp (mmHg)"/>
                                            <div class="o_row">
                                                <field name="systolic"
                                                       attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                       forceOUt_save="1"/>
                                                <label for="diastolic" string="/"/>
                                                <field name="diastolic"
                                                       attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                       force_save="1"/>
                                            </div>
                                            <field name="respiratory_rate"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="bpm"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>

                                            <field name="weight" on_change="onchange_height_weight(height,weight)"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="height" on_change="onchange_height_weight(height,weight)"
                                                   attrs="{'readonly': [('state','in',['WaitPayment','Payment','Completed'])]}"
                                                   force_save="1"/>
                                            <field name="bmi" readonly="1" force_save="1"/>
                                        </group>
                                        <group invisible="1">
                                            <group>
                                                <field name="marital_status" invisible="1"/>
                                                <field name="rh" invisible="1"/>
                                            </group>
                                            <group>
                                                <field name="blood_type" invisible="1"/>
                                            </group>
                                        </group>
                                    </group>
                                </group>
                            </page>
                            <page string="Thông tin Tư vấn" name="advise" icon="fa fa-info">
                                <div class="sh-box-control-print">
                                    <button name="print_assign_patient_services_advisory"
                                            attrs="{'invisible': [('list_advisory_services','=',[])]}"
                                            string="PHIẾU TƯ VẤN" type="object" class="btn-success fa fa-print"/>
                                </div>
                                <group string="Đã tư vấn">
                                    <group>
                                        <field name="level_of_improvement"/>
                                        <field name="service_costs"/>
                                        <field name="other_costs_incurred"/>
                                        <field name="hospital_checkout"/>
                                    </group>
                                    <group>
                                        <field name="warranty"/>
                                        <field name="therapy"/>
                                        <field name="diet"/>
                                    </group>
                                </group>
                                <group>
                                    <field name="doctor_advice"/>
                                    <field name="conclude"/>
                                </group>
                                <group>
                                    <field name="list_advisory_services" domain="[('walkin', '=', active_id)]"
                                           nolabel="1">
                                        <tree delete="false" create="false" string='Phiếu tư vấn dịch vụ'
                                              editable="bottom" class="tree_no_open">
                                            <field name="id" invisible="1"/>
                                            <field name="walkin" optional="hide" readonly="1" force_save="1"/>
                                            <field name="service_advisory" required="1"
                                                   options="{'no_create': True,'no_open': True}" readonly="1"
                                                   force_save="1"/>
                                            <field name="current_state" required="1"/>
                                            <field name="desire" required="1"/>
                                        </tree>
                                    </field>
                                </group>
                            </page>
                            <page string="Phiếu Xét nghiệm" name="lab_test" icon="fa fa-flask">
                                <div class="sh-box-control-print pb-3">
                                    <button name="reset_all_labtest"
                                            attrs="{'invisible':[('state','in',['Completed','Cancelled'])]}"
                                            confirm="Bạn có chắc chắn muốn xóa toàn bộ loại Xét nghiệm đã kê bên dưới?"
                                            string="Xóa tất cả Xét nghiệm" type="object"
                                            class="btn-warning fa fa-trash mr-5"
                                            groups="shealth_all_in_one.group_sh_medical_physician,shealth_all_in_one.group_sh_medical_nurse"/>

                                    <button name="add_config_labtest"
                                            attrs="{'invisible':['|',('state','in',['Completed','Cancelled']),('lab_test_ids','!=',[])]}"
                                            confirm="Bạn có chắc chắn muốn thêm các loại Xét nghiệm đã cấu hình theo dịch vụ?"
                                            string="Thêm các Xét nghiệm theo cấu hình Dịch vụ" type="object"
                                            class="btn-info fa fa-plus mr-5"
                                            groups="shealth_all_in_one.group_sh_medical_physician,shealth_all_in_one.group_sh_medical_nurse"/>
                                </div>
                                <field name="lab_test_ids"
                                       context="{'default_walkin': active_id, 'default_requestor': doctor, 'default_patient': patient, 'default_sex': sex, 'default_dob': dob,'default_department': department,'default_institution': institution}"
                                       domain="[('walkin', '=', active_id)]">
                                    <tree delete="false" string='Lab Tests' decoration-info="state=='Draft'"
                                          decoration-success="state=='Completed'"
                                          decoration-danger="state=='Test In Progress'"
                                          editable="bottom" class="tree_no_open">
                                        <field name="id" invisible="1"/>
                                        <field name="sequence" widget="handle"/>
                                        <field name="name" optional="hide"/>
                                        <field name="walkin" optional="hide" readonly="1" force_save="1"/>
                                        <field name="patient" options="{'no_create': True,'no_open': True}"
                                               class="text-uppercase" readonly="1" force_save="1"/>
                                        <field name="test_type" options="{'no_create': True,'no_open': True}"/>
                                        <field name="institution" options="{'no_create': True,'no_open': True}"
                                               required="1" domain="[('id', 'in', parent.allow_institutions)]"
                                               attrs="{'readonly': [('state','in',['Completed'])]}" force_save="1"/>
                                        <field name="department" options="{'no_create': True,'no_open': True}"
                                               required="1" attrs="{'readonly': [('state','in',['Completed'])]}"
                                               force_save="1"/>
                                        <field name="perform_room" options="{'no_create': True,'no_open': True}"
                                               required="1"/>
                                        <field name="pathologist" options="{'no_create': True,'no_open': True}"/>
                                        <field name="requestor" options="{'no_create': True,'no_open': True}"
                                               optional="hide"/>
                                        <field name="date_requested" required="1"/>
                                        <field name="date_done"/>
                                        <field name="doctor_note" optional="show"/>
                                        <field name="state"/>
                                        <field name="lab_test_material_ids" invisible="1"/>
                                        <field name="lab_test_criteria" invisible="1"/>
                                        <button name="view_detail_labtest" type="object" icon="fa-file-text-o"
                                                title="Chi tiết" style="font-size: 20px;"/>
                                        <button confirm="Bạn có chắc chắn muốn xóa phiếu Xét nghiệm này?"
                                                attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                class="oe_edit_only"
                                                name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                style="font-size: 20px;color:#000;"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Phiếu CĐHA - TDCN" type="imaging_test" icon="fa fa-picture-o"
                                  attrs="{'invisible': [('state','in',['Scheduled','WaitPayment','Payment','Scheduled'])]}">
                                <field name="imaging_ids"
                                       context="{'default_walkin': active_id, 'default_requestor': doctor, 'default_patient': patient, 'default_sex': sex, 'default_dob': dob,'default_department': department,'default_institution': institution}"
                                       domain="[('walkin', '=', active_id)]">
                                    <tree delete="false" string="Imaging Test" decoration-info="state=='Draft'"
                                          decoration-success="state=='Completed'"
                                          decoration-danger="state=='Test In Progress'"
                                          editable="bottom" class="tree_no_open">
                                        <field name="id" invisible="1"/>
                                        <field name="name" optional="hide"/>
                                        <field name="walkin" optional="hide" readonly="1" force_save="1"/>
                                        <field name="patient" options="{'no_create': True,'no_open': True}"
                                               class="text-uppercase" readonly="1" force_save="1"/>
                                        <field name="test_type" options="{'no_create': True,'no_open': True}"/>
                                        <field name="institution" options="{'no_create': True,'no_open': True}"
                                               required="1" domain="[('id', 'in', parent.allow_institutions)]"
                                               attrs="{'readonly': [('state','in',['Completed'])]}" force_save="1"/>
                                        <field name="department" options="{'no_create': True,'no_open': True}"
                                               required="1" attrs="{'readonly': [('state','in',['Completed'])]}"
                                               force_save="1"/>
                                        <field name="perform_room" options="{'no_create': True,'no_open': True}"
                                               required="1"/>
                                        <field name="pathologist" options="{'no_create': True,'no_open': True}"/>
                                        <field name="requestor" options="{'no_create': True,'no_open': True}"
                                               optional="hide"/>
                                        <field name="date_requested"/>
                                        <field name="date_done"/>
                                        <field name="doctor_note" optional="show"/>
                                        <field name="state"/>
                                        <field name="imaging_material_ids" invisible="1"/>
                                        <button name="view_detail_imaging" type="object" icon="fa-file-text-o"
                                                title="Chi tiết" style="font-size: 20px;"/>
                                        <button confirm="Bạn có chắc chắn muốn xóa phiếu CĐHA - TDCN này?"
                                                attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                class="oe_edit_only"
                                                name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                style="font-size: 20px;color:#000;"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Phẫu thuật - Thủ thuật" name="surgeries" icon="fa fa-heartbeat"
                                  attrs="{'invisible': [('state','in',['Scheduled','WaitPayment','Payment','Scheduled'])]}"
                                  groups="shealth_all_in_one.group_sh_medical_physician,shealth_all_in_one.group_sh_medical_nurse">
                                <field name="doctor_surgeon" invisible="1"/>
                                <field name="doctor_anesthetist" invisible="1"/>
                                <field name="surgeries_ids"
                                       context="{'default_is_new_request': True, 'default_walkin': active_id, 'default_pathology': pathology, 'default_patient': patient, 'default_sex': sex, 'default_dob': dob,'default_institution': institution}"
                                       domain="[('walkin', '=', active_id)]">
                                    <tree delete="false" string="Surgeries" decoration-bf="state=='Signed'"
                                          decoration-it="state=='Confirmed'" decoration-info="state=='Draft'"
                                          decoration-success="state=='Done'" decoration-danger="state=='In Progress'"
                                          editable="bottom" class="tree_no_open">
                                        <field name="is_new_request" invisible="1"/>
                                        <field name="id" invisible="1"/>
                                        <field name="name"/>
                                        <field name="walkin" optional="hide" readonly="1" force_save="1"/>
                                        <field name="patient" class="text-uppercase" readonly="1" force_save="1"/>
                                        <field name="services" options="{'no_create': True,'no_open': True}"
                                               required="1" widget="many2many_tags"
                                               attrs="{'readonly': [('state','in',['Done','Signed'])]}"
                                               domain="[('id', 'in', parent.service)]" force_save="1"/>
                                        <field name="surgery_date"/>
                                        <field name="pathology" options="{'no_create': True,'no_open': True}"
                                               optional="hide"/>
                                        <field name="institution" options="{'no_create': True,'no_open': True}"
                                               required="1" domain="[('id', 'in', parent.allow_institutions)]"
                                               attrs="{'readonly': [('id','!=',False)]}" force_save="1"/>
                                        <field name="department" options="{'no_create': True,'no_open': True}"
                                               required="1"/>
                                        <field name="operating_room" options="{'no_create': True,'no_open': True}"
                                               required="1"
                                               domain="[('department','=',department),('state','=','Free'),('is_operating_theater','=',True)]"/>
                                        <field name="surgeon" options="{'no_create': True,'no_open': True}"/>
                                        <field name="anesthetist" options="{'no_create': True,'no_open': True}"/>
                                        <field name="state"/>
                                        <button name="view_detail_surgery"
                                                groups="shealth_all_in_one.group_sh_medical_physician_surgery"
                                                type="object" icon="fa-file-text-o" title="Chi tiết"
                                                style="font-size: 20px;"/>
                                        <button confirm="Bạn có chắc chắn muốn xóa phiếu PTTT này?"
                                                attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                class="oe_edit_only"
                                                name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                style="font-size: 20px;color:#000;"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Chuyên khoa" name="specialty" icon="fa fa-stethoscope"
                                  attrs="{'invisible': [('state','in',['Scheduled','WaitPayment','Payment','Scheduled'])]}"
                                  groups="shealth_all_in_one.group_sh_medical_physician,shealth_all_in_one.group_sh_medical_nurse">
                                <field name="specialty_ids"
                                       context="{'default_is_new_request': True, 'default_walkin': active_id,'default_pathology': pathology, 'default_patient': patient, 'default_sex': sex, 'default_dob': dob,'default_institution': institution}"
                                       domain="[('walkin', '=', active_id)]">
                                    <tree delete="false" string="Specialty" decoration-bf="state=='Signed'"
                                          decoration-it="state=='Confirmed'" decoration-info="state=='Draft'"
                                          decoration-success="state=='Done'" decoration-danger="state=='In Progress'"
                                          editable="bottom" class="tree_no_open">
                                        <field name="is_new_request" invisible="1"/>
                                        <field name="id" invisible="1"/>
                                        <field name="name"/>
                                        <field name="walkin" optional="hide" readonly="1" force_save="1"/>
                                        <field name="patient" class="text-uppercase" readonly="1" force_save="1"
                                               options="{'no_create': True,'no_open': True}"/>
                                        <field name="services" options="{'no_create': True,'no_open': True}"
                                               required="1" widget="many2many_tags"
                                               attrs="{'readonly': [('state','in',['Done'])]}"
                                               domain="[('id', 'in', parent.service)]" force_save="1"/>
                                        <field name="pathology" options="{'no_create': True,'no_open': True}"
                                               optional="hide"/>
                                        <field name="services_date"/>
                                        <field name="institution" options="{'no_create': True,'no_open': True}"
                                               required="1" domain="[('id', 'in', parent.allow_institutions)]"/>
                                        <field name="department" options="{'no_create': True,'no_open': True}"
                                               required="1" attrs="{'readonly': [('id','!=',False)]}" force_save="1"/>
                                        <field name="perform_room" options="{'no_create': True,'no_open': True}"
                                               required="1"/>
                                        <field name="physician" options="{'no_create': True,'no_open': True}"/>
                                        <field name="state"/>
                                        <field name="show_specialty" invisible="1"/>
                                        <button name="view_detail_specialty" type="object" icon="fa-file-text-o"
                                                attrs="{'invisible': [('show_specialty','=',False)]}" title="Chi tiết"
                                                style="font-size: 20px;"/>
                                        <button confirm="Bạn có chắc chắn muốn xóa phiếu Chuyên khoa này?"
                                                attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                class="oe_edit_only"
                                                name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                style="font-size: 20px;color:#000;"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Bệnh nhân lưu" name="inpatient_admissions" icon="fa fa-h-square"
                                  attrs="{'invisible': [('state','in',['Scheduled','WaitPayment','Payment','Scheduled'])]}"
                                  groups="shealth_all_in_one.group_sh_medical_physician,shealth_all_in_one.group_sh_medical_nurse">
                                <field name="inpatient_ids"
                                       context="{'default_institution': institution,'default_walkin': active_id,'default_admission_reason':pathology,'default_admission_type':'Elective','default_patient':patient,'default_operating_physician':doctor_surgeon,'default_attending_physician':doctor_anesthetist}"
                                       domain="[('walkin', '=', active_id)]">
                                    <tree class="sh_has_icon tree_no_open" delete="false" string='Inpatient Admission'
                                          decoration-info="state=='Draft'" decoration-danger="state=='Hospitalized'"
                                          decoration-success="state=='Discharged'"
                                          decoration-muted="state=='Cancelled'"
                                          editable="bottom">
                                        <field name="walkin" optional="hide" readonly="1" force_save="1"/>
                                        <field name="id" invisible="1"/>
                                        <field name="name"/>
                                        <field name="patient" class="text-uppercase" readonly="1" force_save="1"/>
                                        <field name="admission_type" invisible="1"/>
                                        <field name="institution" required="1"
                                               domain="[('id', 'in', parent.allow_institutions)]"
                                               options="{'no_create': True,'no_open': True}"/>
                                        <field name="ward" required="1" options="{'no_create': True,'no_open': True}"/>
                                        <field string="Phòng" name="room" required="1"
                                               options="{'no_create': True,'no_open':True}"
                                               attrs="{'readonly':[('state','!=','Draft')]}"/>
                                        <field name="bed" options="{'no_create': True,'no_open': True}"
                                               domain="[('state','=','Free'),('room','=',room)]"/>
                                        <field name="services" options="{'no_create': True,'no_open': True}"
                                               required="1" widget="many2many_tags"
                                               attrs="{'readonly': [('state','in',['Invoiced','Discharged','Cancelled'])]}"
                                               domain="[('id', 'in', parent.service)]" force_save="1"/>
                                        <field name="admission_date" required="1"/>
                                        <field name="discharge_date"/>
                                        <field name="state" readonly="1" force_save="1"/>
                                        <button name="view_detail_inpatient"
                                                groups="shealth_all_in_one.group_sh_medical_physician_surgery"
                                                type="object" icon="fa-file-text-o"
                                                title="Chi tiết"/>
                                        <button attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                class="oe_edit_only"
                                                name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                style="font-size: 20px;color:#000;"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Xử trí - Đơn thuốc" name="treatment" icon="fa fa-list"
                                  attrs="{'invisible': [('state','in',['Scheduled','WaitPayment','Payment','Scheduled'])]}">
                                <group>
                                    <group>
                                        <field name="handle" string="Xử trí"
                                               attrs="{'required' :[('state','in',['Completed'])]}"/>
                                        <field name="comments" string="Lời dặn bác sĩ"/>
                                    </group>
                                    <group>
                                        <field name="date_out" attrs="{'readonly': [('state','=','Completed')]}"/>
                                        <field name="close_walkin" readonly="True"/>
                                    </group>
                                </group>
                                <group string="Prescriptions">
                                    <field nolabel="1" name="prescription_ids" options="{'reload_on_button': true}"
                                           domain="[('walkin', '=', active_id)]"
                                           context="{'view_only_name': True,'default_institution': institution,'default_walkin': active_id, 'default_date': date, 'default_date_out': date, 'default_is_normal': True, 'default_patient': patient,'default_doctor': doctor}">
                                        <tree string="Đơn thuốc" class="sh_has_icon tree_no_open" delete="false"
                                              decoration-info="state=='Draft'"
                                              decoration-danger="state=='Sent to Pharmacy'"
                                              decoration-success="state=='Đã xuất thuốc'"
                                              editable="bottom">
                                            <field name="id" invisible="1"/>
                                            <field name="walkin" force_save="1" optional="hide" readonly="1"/>
                                            <field name="evaluation" force_save="1" optional="hide" readonly="1"/>
                                            <field name="name" force_save="1"/>
                                            <field name="date"/>
                                            <field name="date_out" optional="hide" readonly="1" force_save="1"/>
                                            <field name="patient" class="text-uppercase" optional="hide" readonly="1"
                                                   force_save="1"/>
                                            <field name="services" options="{'no_create': True,'no_open': True}"
                                                   widget="many2many_tags"
                                                   attrs="{'readonly': [('state','in',['Send to Pharmacy','Đã xuất thuốc'])]}"
                                                   domain="[('id', 'in', parent.service)]" force_save="1"/>
                                            <field name="doctor" options="{'no_create': True,'no_open': True}"/>
                                            <field name="pharmacy" invisible="1"/>
                                            <field name="institution" domain="[('id', 'in', parent.allow_institutions)]"
                                                   options="{'no_create': True,'no_open': True}"/>
                                            <field name="room_request" optional="show" required="1"
                                                   options="{'no_create': True,'no_open': True}"
                                                   attrs="{'readonly': [('state','!=','Draft')]}"/>
                                            <field name="room_stock_out" options="{'no_create': True,'no_open': True}"
                                                   attrs="{'readonly': [('state','!=','Draft')]}"/>
                                            <field name="state"/>
                                            <button name="view_detail_prescriptions" type="object" icon="fa-file-text-o"
                                                    title="Chi tiết"/>
                                            <button attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                    class="oe_edit_only"
                                                    name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                    style="font-size: 20px;color:#000;"/>
                                        </tree>
                                    </field>
                                </group>
                            </page>
                            <page string="Hướng dẫn - Lịch tái khám" name="reexam" icon="fa fa-list"
                                  attrs="{'invisible': [('state','in',['Scheduled','WaitPayment','Payment','Scheduled'])]}">
                                <field nolabel="1" name="reexam_ids"
                                       domain="[('walkin', '=', active_id)]"
                                       context="{'default_patient': patient,'default_walkin': active_id, 'default_date': service_date}">
                                    <tree string="Lịch chăm sóc" class="sh_has_icon tree_no_open" delete="false"
                                          decoration-info="state=='Draft'"
                                          decoration-success="state=='Confirmed'"
                                          editable="bottom">
                                        <field name="id" invisible="1"/>
                                        <field name="name" readonly="1" force_save="1"/>
                                        <field name="walkin" force_save="1" optional="hide" readonly="1"/>
                                        <field name="company" required="True"
                                               options="{'no_create': True,'no_open': True}"/>
                                        <field name="date" required="1" attrs="{'readonly': [('id','!=',False)]}"
                                               force_save="1"/>
                                        <field name="date_out" required="1" attrs="{'readonly': [('id','!=',False)]}"
                                               force_save="1"/>
                                        <field name="patient" class="text-uppercase" readonly="1" force_save="1"/>
                                        <field name="services" required="1"
                                               options="{'no_create': True,'no_open': True}" widget="many2many_tags"
                                               attrs="{'readonly': [('id','!=',False)]}"
                                               domain="[('id', 'in', parent.service)]" force_save="1"/>
                                        <field name="state"/>
                                        <field name="end_service"/>
                                        <button name="view_detail_reexam" type="object" icon="fa-file-text-o"
                                                title="Chi tiết"/>
                                        <button attrs="{'invisible': ['|',('state','!=','Draft'),('id','=',False)]}"
                                                class="oe_edit_only"
                                                name="unlink" type="object" icon="fa-trash-o" title="Xóa"
                                                style="font-size: 20px;color:#000;"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>


        <record id="sh_medical_update_uom_price_source_view_extend" model="ir.ui.view">
            <field name="name">Phiếu khám bệnh - Cập nhật Đơn vị xử lý và nguồn</field>
            <field name="model">sh.medical.appointment.register.walkin</field>
            <field name="inherit_id" ref="his_extend.phieu_kham_form_view_extend"/>
            <field name="arch" type="xml">
                <xpath expr="//header//button[@name='set_to_cancelled']" position="after">
                    <button name="crm_update_uom_price_source_action" states="Scheduled,WaitPayment,InProgress"
                            string="Cập nhật đơn vị xử lý và nguồn" title="Thay đổi đơn vị xử lý và nguồn"
                            type="object" class="btn-warning fa fa-wrench"
                            groups="shealth_all_in_one.group_sh_medical_physician"/>
                </xpath>
            </field>
        </record>

        <record id="phieu_kham_extend_action_server" model="ir.actions.server">
            <field name="name">Phiếu khám</field>
            <field name="model_id" ref="shealth_all_in_one.model_sh_medical_appointment_register_walkin"/>
            <field name="state">code</field>
            <field name="code">
                action = model.his_extend_action_view_walkin()
            </field>
        </record>

        <record id="phieu_kham_extend_action" model="ir.actions.act_window">
            <field name="name">Phiếu khám</field>
            <field name="res_model">sh.medical.appointment.register.walkin</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">['|', ('company_id', 'in', allowed_company_ids), ('company2_id', 'in',
                allowed_company_ids)]
            </field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('his_extend.phieu_kham_tree_view_extend')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('his_extend.phieu_kham_form_view_extend')})]"/>
            <field name="context">{'search_default_group_date': True}</field>
        </record>

        <record id="phieu_kham_surgery_extend_action" model="ir.actions.act_window">
            <field name="name">Phiếu khám Phẫu thuật</field>
            <field name="res_model">sh.medical.appointment.register.walkin</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">['|', ('company_id', 'in', allowed_company_ids), ('company2_id', 'in',
                allowed_company_ids),('room_type', '=', 'Surgery')]
            </field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('his_extend.phieu_kham_tree_view_extend')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('his_extend.phieu_kham_form_view_extend')})]"/>
            <field name="context">{'search_default_group_date': True}</field>
        </record>

        <record id="phieu_kham_spa_extend_action" model="ir.actions.act_window">
            <field name="name">Phiếu khám Spa</field>
            <field name="res_model">sh.medical.appointment.register.walkin</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">['|', ('company_id', 'in', allowed_company_ids), ('company2_id', 'in',
                allowed_company_ids),('room_type', '=', 'Spa')]
            </field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('his_extend.phieu_kham_tree_view_extend')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('his_extend.phieu_kham_form_view_extend')})]"/>
            <field name="context">{'search_default_group_date': True}</field>
        </record>

        <record id="phieu_kham_laser_extend_action" model="ir.actions.act_window">
            <field name="name">Phiếu khám Laser</field>
            <field name="res_model">sh.medical.appointment.register.walkin</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">['|', ('company_id', 'in', allowed_company_ids), ('company2_id', 'in',
                allowed_company_ids),('room_type', '=', 'Laser')]
            </field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('his_extend.phieu_kham_tree_view_extend')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('his_extend.phieu_kham_form_view_extend')})]"/>
            <field name="context">{'search_default_group_date': True}</field>
        </record>

        <record id="phieu_kham_odontology_extend_action" model="ir.actions.act_window">
            <field name="name">Phiếu khám Nha khoa</field>
            <field name="res_model">sh.medical.appointment.register.walkin</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">['|', ('company_id', 'in', allowed_company_ids), ('company2_id', 'in',
                allowed_company_ids),('room_type', '=', 'Odontology')]
            </field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('his_extend.phieu_kham_tree_view_extend')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('his_extend.phieu_kham_form_view_extend')})]"/>
            <field name="context">{'search_default_group_date': True}</field>
        </record>

    </data>
</odoo>